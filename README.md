# HA Flask Deployment: Terraform + Ansible Integration (V2)

## üåü Project Overview: Highly Available Infrastructure as Code

This project demonstrates a production-ready **Infrastructure as Code (IaC)** workflow by seamlessly integrating **Terraform** for cloud resource provisioning (Day 0) and **Ansible** for configuration management and application deployment (Day 1).

The goal is to deploy a simple, interactive **Flask Adventure Game** application onto a **Highly Available (HA)** architecture on AWS.

### Architectural Goals

  * **High Availability:** Deploy two identical EC2 instances across two separate **Availability Zones (AZs)** to ensure the application remains functional even if one zone experiences an outage.

  * **Infrastructure Isolation:** Create a dedicated Virtual Private Cloud (VPC) network from scratch, rather than relying on default settings.

  * **Dynamic Handover:** Automatically generate the Ansible host inventory using Terraform's outputs, eliminating manual IP address configuration.

## üõ†Ô∏è Technology Stack

| Tool | Role | Description |
| :--- | :--- | :--- |
| **Terraform** | **Provisioning (IaC)** | Creates the VPC, Subnets, Internet Gateway, Security Group, and the two EC2 instances. |
| **Ansible** | **Configuration Management** | Connects via SSH to both new EC2s to install Python/Flask, deploy the application code, and start the service. |
| **AWS** | **Cloud Provider** | Hosting environment (EC2, VPC, Networking). |
| **Python/Flask** | **Application** | The simple, state-managing "HA Adventure Game" microservice. |

## üìÅ Project Structure

The repository is organized following best practices to separate infrastructure code from configuration code:

```
ha-flask-project/
‚îú‚îÄ‚îÄ .gitignore               # Ignores .tfstate files, .pem keys, and inventory.ini
‚îú‚îÄ‚îÄ main.tf                  # Main Terraform configuration (VPC, Subnets, EC2, IGW, SG)
‚îú‚îÄ‚îÄ ansible/
‚îÇ   ‚îú‚îÄ‚îÄ inventory.tmpl       # Terraform template to generate the host list
‚îÇ   ‚îú‚îÄ‚îÄ inventory.ini        # (Generated by Terraform) Ansible's list of live host IPs
‚îÇ   ‚îú‚îÄ‚îÄ run_deployment.yml   # Master Ansible playbook, which calls the webserver role
‚îÇ   ‚îî‚îÄ‚îÄ roles/
‚îÇ       ‚îî‚îÄ‚îÄ webserver/
‚îÇ           ‚îú‚îÄ‚îÄ tasks/
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ main.yml # Task logic (Install Python, Copy File, Start App)
‚îÇ           ‚îî‚îÄ‚îÄ files/
‚îÇ               ‚îî‚îÄ‚îÄ adventure_game.py # The Flask V2 game code

```


##  HA Flask Deployment Workflow

+------------------+     +-----------------------+     +-------------------+     +---------------------+     +---------------------+     +----------------------+
| 1. Local Dev Env | --> | 2. Code Repository    | --> | 3. Terraform Init | --> | 4. Terraform Apply  | --> | 5. Ansible Playbook | --> | 6. Application Access|
| (KodeKloud)      |     | (ha-flask-project/)   |     | (Downloads AWS    |     | (Builds AWS Infra)  |     | (Configures EC2s)   |     |(Browser/Verification)|
|                  |     | - main.tf             |     | Provider)         |     | - VPC, Subnets      |     | - Installs Python   |     | - http://IP:8000     |
|                  |     | - ansible/*           |     |                   |     | - IGW, RouteTable   |     | - Deploys Flask App |     | - Two different IPs  |
|                  |     | - .gitignore          |     |                   |     | - Security Group    |     | - Starts Flask Svc  |     | - HA Adventure Game  |
|                  |     |                       |     |                   |     | - 2 EC2 Instances   |     |                     |     |                      |
|                  |     |                       |     |                   |     | - Generates         |     |                     |     |                      |
|                  |     |                       |     |                   |     |ansible/inventory.ini|     |                     |     |                      |
+------------------+     +-----------------------+     +-------------------+     +---------------------+     +---------------------+     +----------------------+
                                                                                              |
                                                                                              | (Wait 90s for SSH)
                                                                                              V
                                                                                    +---------------------+
                                                                                    | 4a. AWS Resources   |
                                                                                    |     (Live)          |
                                                                                    +---------------------+


## üöÄ Deployment Instructions

These instructions assume you are running from a **Linux-like environment (e.g., KodeKloud Terminal)** with Terraform and Ansible installed.

### Prerequisites

1.  **Git, Terraform, and Ansible** installed.

2.  **AWS Key Pair:** A named key pair (e.g., `my-ha-key`) must be imported into your target AWS region, and the matching private key (`~/.ssh/my_ha_key`) must be saved in your local user directory for SSH access.

### Step 1: Initialize Git and Clone (Skip if already on Playground)

*(Assuming files are already in place on the Playground)*

### Step 2: Initialize Terraform

Run this in the root of the project to download the necessary AWS provider:

```
terraform init
```

### Step 3: Provision Infrastructure (Day 0)

Review the plan (which should show about 10 new resources) and apply the changes.

```
terraform plan
terraform apply  # Type 'yes' to confirm
```

***CRUCIAL PAUSE:*** After `terraform apply` finishes, wait **90 seconds** for the two EC2 instances to boot up and initialize SSH.

### Step 4: Configure and Deploy Application (Day 1)

Execute the Ansible playbook, which connects to both EC2 instances simultaneously using the dynamically generated `ansible/inventory.ini` file.

```
ansible-playbook -i ansible/inventory.ini ansible/run_deployment.yml
```

### Step 5: Verification

Use the Public IP addresses output by Terraform (under `server_public_ips`) to access the application on port **8000**:

  * **URL:** `http://<PUBLIC_IP_ADDRESS>:8000`

  * Verify that refreshing the page sometimes shows **different hostnames** in the `Server Hostname:` field, confirming the traffic is being served from two separate, independent machines (the core goal of the HA deployment).

### üßπ Cleanup

Always destroy your resources to avoid unnecessary cloud costs:

```
terraform destroy  # Type 'yes' to confirm
```

## üìù Version History

  * **v2.0.0 (Current):** Upgraded application to an interactive Flask Adventure Game. Implemented Ansible Roles and a robust HA network foundation.

  * **v1.0.0:** Initial basic EC2 deployment and simple "Hello World" configuration.
