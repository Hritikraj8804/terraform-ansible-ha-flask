---
- name: 1. Update apt cache
  ansible.builtin.apt:
    update_cache: yes

- name: 2. Install Python, pip, and Flask
  ansible.builtin.apt:
    name: 
      - python3
      - python3-pip
    state: present

- name: 3. Install Flask using pip
  ansible.builtin.pip:
    name: flask
    executable: pip3
    state: present

- name: 4. Ensure app directory exists
  ansible.builtin.file:
    path: /opt/flask_app
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: 5. Copy Flask application file
  ansible.builtin.copy:
    src: hello_app.py
    dest: /opt/flask_app/hello_app.py
    owner: ubuntu
    group: ubuntu

- name: 6. Start the Flask application using nohup (runs in background)
  ansible.builtin.shell: |
    fuser -k 8000/tcp || true 
    /usr/bin/nohup /usr/bin/python3 /opt/flask_app/hello_app.py > /tmp/flask.log 2>&1 &
  args:
    chdir: /opt/flask_app
  changed_when: true
